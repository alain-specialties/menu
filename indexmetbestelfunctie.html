<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Philbo Data Viewer</title>
    <style>
        /* Base styles adopted from the original code */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111;
            color: #c0a16b;
            padding: 20px;
            user-select: none;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }
        .container {
            width: 90%;
            max-width: 1200px;
        }
        h1, h2 {
            text-align: center;
            color: #c0a16b;
        }
        #loginBox, #orderBox, #cartSummary, #checkoutForm, #orderConfirmation {
            text-align: center;
            margin-top: 100px;
            padding: 20px;
            border-radius: 10px;
            background-color: #222;
        }
        input, select {
            padding: 8px;
            margin: 5px;
            border-radius: 5px;
            border: 1px solid #555;
            background-color: #333;
            color: #c0a16b;
        }
        button, .cart-button {
            padding: 8px 16px;
            margin: 5px;
            border-radius: 5px;
            background-color: #555;
            color: #fff;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover, .cart-button:hover {
            background-color: #777;
        }
        #loginError, #messageBox {
            color: red;
            font-weight: bold;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            cursor: default;
            table-layout: fixed; /* Ensures a fixed column layout */
        }
        th, td {
            border: 1px solid #555;
            padding: 5px; /* Compact padding */
            text-align: left;
            color: #c0a16b;
            font-size: 0.8em; /* Smaller font size */
        }
        /* Ensure all table data is on a single line */
        #cigarTable td {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        th {
            background-color: #333;
            cursor: pointer;
        }
        tr:nth-child(even) {
            background-color: #222;
        }
        #searchBox {
            margin: 10px 0;
            padding: 8px;
            width: 100%;
            box-sizing: border-box;
        }
        th.sort-asc::after {
            content: " \25B2";
        }
        th.sort-desc::after {
            content: " \25BC";
        }
        #legend, #disclaimer {
            margin-top: 10px;
            font-size: 14px;
            color: #c0a16b;
        }
        #disclaimer {
            font-style: italic;
        }
        
        /* New modal styles for error messages and notifications */
        #messageModal, #ageVerificationModal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #333;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 400px;
            text-align: center;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .close-button {
            color: #c0a16b;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: #fff;
            text-decoration: none;
            cursor: pointer;
        }

        /* Cart section styles */
        #cartSummary {
            margin-top: 20px;
            text-align: left;
            padding: 15px;
            display: none; /* Hidden by default */
        }
        #cartSummary h3 {
            text-align: center;
            margin-bottom: 10px;
        }
        #cartItemsList {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        #cartItemsList li {
            border-bottom: 1px solid #444;
            padding: 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .quantity-controls button {
            padding: 2px 8px;
        }
        #cartTotal {
            font-weight: bold;
            text-align: right;
            margin-top: 10px;
        }

        /* Checkout form styles */
        #checkoutForm {
            margin-top: 20px;
            text-align: left;
            display: none; /* Hidden by default */
        }
        #checkoutForm input, #checkoutForm textarea {
            width: calc(100% - 10px);
            margin-bottom: 10px;
        }
        .pickup-note {
            background-color: #333;
            border: 2px solid #c0a16b;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            font-style: italic;
            text-align: center; /* Centered text */
            color: #e6b800; /* Same color as the payment link */
        }
        /* Style for the new framed deposit section */
        #checkoutForm .payment-info {
            background-color: #333;
            border: 2px solid #c0a16b; /* Added border */
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            margin-top: 15px;
        }
        #checkoutForm .payment-info a {
            color: #e6b800;
            text-decoration: underline;
        }
        #checkoutForm .payment-info a:hover {
            color: #ffcc00;
        }
        
        /* New flexbox style for the order button and input field */
        .order-controls {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Nieuwe CSS voor de 'add to cart' knop */
        .cart-button {
            /* Maak de knop groter */
            padding: 15px 30px;
            font-size: 1.2rem;
            /* Plaats de knop aan de rechterkant */
            float: right;
            margin-left: 20px;
        }
    </style>
</head>
<body oncontextmenu="return false;">
    <div class="container">
        <h1>Philbo Data Viewer</h1>
        <div id="loginBox">
            <h2>Login</h2>
            <input type="text" id="username" placeholder="Username"><br>
            <input type="password" id="password" placeholder="Password"><br>
            <button onclick="checkLogin()">Login</button>
            <p id="loginError" style="color:red;"></p>
        </div>
        <div id="catalog" style="display:none;">
            <input type="text" id="searchBox" placeholder="Search..." onkeyup="filterTable()">
            <div id="legend">Legend: V = In stock &nbsp; O = Pre-order by BOX if available</div>
            <div id="disclaimer">Prices are indicative and subject to change. The final price is determined by the tax stamp at the time of delivery.</div>
            <button class="cart-button" onclick="showCart()">ðŸ›’ Cart (<span id="cartItemCount">0</span>)</button>
            <table id="cigarTable">
                <thead>
                    <tr id="headerRow"></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        
        <div id="cartSummary" style="display:none;">
            <h3>Your Order</h3>
            <ul id="cartItemsList">
                </ul>
            <p id="cartTotal">Total: â‚¬0.00</p>
            <button onclick="showCheckout()">Proceed to Checkout</button>
            <button onclick="showCatalog()">Back to Catalog</button>
        </div>

        <div id="checkoutForm" style="display:none;">
            <h3>Your Details</h3>
            <div class="pickup-note">
                <p>All orders must be picked up. It is forbidden by law to ship tobacco products.</p>
            </div>
            <p>Please enter your details and place your order. The order will be sent to us via email.</p>
            <input type="text" id="customerName" placeholder="Name" required><br>
            <input type="email" id="customerEmail" placeholder="Email" required><br>
            <input type="tel" id="customerPhone" placeholder="Phone Number"><br>
            <input type="text" id="customerAddress" placeholder="Address"><br>
            <textarea id="customerNotes" placeholder="Order notes..." rows="4"></textarea><br>
            <div class="payment-info">
                <p>Don't forget to pay a 50% deposit via the link below.</p>
                <p id="depositAmount">The deposit amount is: â‚¬0.00</p>
                <a href="https://revolut.me/alainthgq" target="_blank">revolut.me/alainthgq</a>
            </div>
            <button onclick="sendOrder()">Place Order</button>
            <button onclick="showCart()">Back to Cart</button>
        </div>
    </div>
    
    <div id="messageModal">
      <div class="modal-content">
        <span class="close-button" onclick="hideMessage()">&times;</span>
        <p id="messageText"></p>
      </div>
    </div>

    <div id="ageVerificationModal">
        <div class="modal-content">
            <p>This website contains information about tobacco products. According to Belgian law, the sale of tobacco products is prohibited for persons under 18 years of age. By clicking 'Confirm', you declare that you are 18 years or older.</p>
            <button onclick="confirmAge()">Confirm</button>
            <button onclick="denyAge()">Cancel</button>
        </div>
    </div>
    
    <script>
        // Storage for loaded data and sorting status
        let allData = [];
        let currentSort = { index: -1, asc: true };
        // Cart storage: An array of objects, each with a product and quantity
        let cart = [];

        // ===== Helper Functions =====
        
        /**
         * Removes the UTF-8 Byte Order Mark (BOM) if present.
         * @param {string} s The input string.
         * @returns {string} The string without the BOM.
         */
        function stripBOM(s) { return s && s.charCodeAt(0) === 0xFEFF ? s.slice(1) : s; }

        /**
         * Detects the CSV delimiter.
         * @param {string} text The CSV text.
         * @returns {string} The detected delimiter.
         */
        function detectDelimiter(text) {
            const firstLine = (text.split(/\r?\n/).find(l => l.trim().length > 0) || "");
            const counts = { ';': 0, ',': 0, '\t': 0, '|': 0 };
            let inQuotes = false;
            for (let i = 0; i < firstLine.length; i++) {
                const ch = firstLine[i];
                if (ch === '"') {
                    if (inQuotes && firstLine[i + 1] === '"') { i++; continue; }
                    inQuotes = !inQuotes; continue;
                }
                if (!inQuotes && counts.hasOwnProperty(ch)) counts[ch]++;
            }
            let best = ';', bestCount = -1;
            for (const k in counts) {
                if (counts[k] > bestCount) {
                    best = k;
                    bestCount = counts[k];
                }
            }
            return bestCount <= 0 ? ';' : best;
        }

        /**
         * Parses CSV text into an array of rows.
         * @param {string} text The CSV text.
         * @param {string} delimiter The delimiter.
         * @returns {Array<Array<string>>} The parsed data.
         */
        function parseCSV(text, delimiter) {
            const rows = [];
            let row = [], field = '';
            let inQuotes = false;
            for (let i = 0; i < text.length; i++) {
                const ch = text[i];
                if (ch === '"') {
                    if (inQuotes && text[i + 1] === '"') { field += '"'; i++; continue; }
                    inQuotes = !inQuotes; continue;
                }
                if (!inQuotes && ch === delimiter) { row.push(field); field = ''; continue; }
                if (!inQuotes && (ch === '\n' || ch === '\r' && text[i + 1] !== '\n')) {
                    row.push(field); rows.push(row); row = []; field = ''; continue;
                }
                if (!inQuotes && ch === '\r') { continue; }
                field += ch;
            }
            if (field.length || row.length) { row.push(field); rows.push(row); }
            return rows.filter(r => r.some(cell => String(cell).trim().length > 0));
        }

        /**
         * Normalizes a string for comparison.
         * @param {string} s The input string.
         * @returns {string} The normalized string.
         */
        function normalizeKey(s) {
            return String(s || '')
                .toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                .replace(/â‚¬/g, 'eur')
                .replace(/[^a-z0-9#]+/g, '');
        }

        // Definitions of the desired columns and their possible names
        const TARGETS = [
            { label: 'Stock', keys: ['stock', 'voorraad'], loose: ['qty', 'quantity'] },
            { label: 'Brand', keys: ['brand'] },
            { label: 'Brand 2', keys: ['brand2', 'brand_2', 'subbrand', 'lijn', 'line'] },
            { label: 'Brand 3', keys: ['brand3', 'brand_3', 'series', 'serie', 'subline'] },
            { label: '# Box', keys: ['#box', 'qtybox', 'aantalperbox', 'aantalbox', 'unitsperbox', 'pcsperbox', 'perbox', 'nbox'] },
            { label: 'â‚¬ Box', keys: ['eurbox', 'boxprice', 'prijsbox', 'prijsperbox', 'boxeur', 'eurperbox'] },
            { label: 'Size', keys: ['size', 'maat', 'afmeting', 'lengthring', 'format', 'vitola'] },
            { label: 'Country', keys: ['country', 'land', 'origin', 'herkomst', 'origine'] }
        ];

        /**
         * Builds a mapping from the CSV headers to the desired columns.
         * @param {Array<string>} header The array with the raw headers.
         * @returns {{mapping: Array<number>, norm: Array<string>}} An object with the mapping and normalized headers.
         */
        function buildHeaderMapping(header) {
            const norm = header.map(normalizeKey);
            const used = new Set();
            const mapping = new Array(TARGETS.length).fill(-1);

            function findIndex(keys, allowLoose) {
                for (let i = 0; i < norm.length; i++) {
                    if (used.has(i)) continue;
                    for (const k of keys) {
                        if (norm[i] === k) {
                            used.add(i);
                            return i;
                        }
                    }
                }
                if (!allowLoose) return -1;
                for (let i = 0; i < norm.length; i
