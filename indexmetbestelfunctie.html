<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Philbo Data Viewer</title>
Â  Â  <style>
Â  Â  Â  Â  /* Base styles adopted from the original code */
Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: 'Inter', sans-serif;
Â  Â  Â  Â  Â  Â  background-color: #111;
Â  Â  Â  Â  Â  Â  color: #c0a16b;
Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  Â  Â  user-select: none;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  align-items: flex-start;
Â  Â  Â  Â  Â  Â  min-height: 100vh;
Â  Â  Â  Â  }
Â  Â  Â  Â  .container {
Â  Â  Â  Â  Â  Â  width: 90%;
Â  Â  Â  Â  Â  Â  max-width: 1200px;
Â  Â  Â  Â  }
Â  Â  Â  Â  h1, h2 {
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  color: #c0a16b;
Â  Â  Â  Â  }
Â  Â  Â  Â  #loginBox, #orderBox, #cartSummary, #checkoutForm, #orderConfirmation {
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  margin-top: 100px;
Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  Â  Â  border-radius: 10px;
Â  Â  Â  Â  Â  Â  background-color: #222;
Â  Â  Â  Â  }
Â  Â  Â  Â  input, select {
Â  Â  Â  Â  Â  Â  padding: 8px;
Â  Â  Â  Â  Â  Â  margin: 5px;
Â  Â  Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  Â  Â  border: 1px solid #555;
Â  Â  Â  Â  Â  Â  background-color: #333;
Â  Â  Â  Â  Â  Â  color: #c0a16b;
Â  Â  Â  Â  }
Â  Â  Â  Â  button, .cart-button {
Â  Â  Â  Â  Â  Â  padding: 8px 16px;
Â  Â  Â  Â  Â  Â  margin: 5px;
Â  Â  Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  Â  Â  background-color: #555;
Â  Â  Â  Â  Â  Â  color: #fff;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  transition: background-color 0.3s;
Â  Â  Â  Â  }
Â  Â  Â  Â  button:hover, .cart-button:hover {
Â  Â  Â  Â  Â  Â  background-color: #777;
Â  Â  Â  Â  }
Â  Â  Â  Â  #loginError, #messageBox {
Â  Â  Â  Â  Â  Â  color: red;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  }
Â  Â  Â  Â  table {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  border-collapse: collapse;
Â  Â  Â  Â  Â  Â  margin-top: 15px;
Â  Â  Â  Â  Â  Â  cursor: default;
Â  Â  Â  Â  }
Â  Â  Â  Â  th, td {
Â  Â  Â  Â  Â  Â  border: 1px solid #555;
Â  Â  Â  Â  Â  Â  padding: 8px;
Â  Â  Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  Â  Â  color: #c0a16b;
Â  Â  Â  Â  }
Â  Â  Â  Â  th {
Â  Â  Â  Â  Â  Â  background-color: #333;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  }
Â  Â  Â  Â  tr:nth-child(even) {
Â  Â  Â  Â  Â  Â  background-color: #222;
Â  Â  Â  Â  }
Â  Â  Â  Â  #searchBox {
Â  Â  Â  Â  Â  Â  margin: 10px 0;
Â  Â  Â  Â  Â  Â  padding: 8px;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  }
Â  Â  Â  Â  th.sort-asc::after {
Â  Â  Â  Â  Â  Â  content: " \25B2";
Â  Â  Â  Â  }
Â  Â  Â  Â  th.sort-desc::after {
Â  Â  Â  Â  Â  Â  content: " \25BC";
Â  Â  Â  Â  }
Â  Â  Â  Â  #legend, #disclaimer {
Â  Â  Â  Â  Â  Â  margin-top: 10px;
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  Â  Â  color: #c0a16b;
Â  Â  Â  Â  }
Â  Â  Â  Â  #disclaimer {
Â  Â  Â  Â  Â  Â  font-style: italic;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* New modal styles for error messages and notifications */
Â  Â  Â  Â  #messageModal {
Â  Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  z-index: 1000;
Â  Â  Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  Â  Â  background-color: rgba(0,0,0,0.4);
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  }
Â  Â  Â  Â  .modal-content {
Â  Â  Â  Â  Â  Â  background-color: #333;
Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  Â  Â  border: 1px solid #888;
Â  Â  Â  Â  Â  Â  width: 80%;
Â  Â  Â  Â  Â  Â  max-width: 400px;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  border-radius: 10px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 5px 15px rgba(0,0,0,0.5);
Â  Â  Â  Â  }
Â  Â  Â  Â  .close-button {
Â  Â  Â  Â  Â  Â  color: #c0a16b;
Â  Â  Â  Â  Â  Â  float: right;
Â  Â  Â  Â  Â  Â  font-size: 28px;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  }
Â  Â  Â  Â  .close-button:hover,
Â  Â  Â  Â  .close-button:focus {
Â  Â  Â  Â  Â  Â  color: #fff;
Â  Â  Â  Â  Â  Â  text-decoration: none;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Cart section styles */
Â  Â  Â  Â  #cartSummary {
Â  Â  Â  Â  Â  Â  margin-top: 20px;
Â  Â  Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  Â  Â  display: none; /* Hidden by default */
Â  Â  Â  Â  }
Â  Â  Â  Â  #cartSummary h3 {
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  }
Â  Â  Â  Â  #cartItemsList {
Â  Â  Â  Â  Â  Â  list-style-type: none;
Â  Â  Â  Â  Â  Â  padding: 0;
Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  }
Â  Â  Â  Â  #cartItemsList li {
Â  Â  Â  Â  Â  Â  border-bottom: 1px solid #444;
Â  Â  Â  Â  Â  Â  padding: 8px 0;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  }
Â  Â  Â  Â  .quantity-controls button {
Â  Â  Â  Â  Â  Â  padding: 2px 8px;
Â  Â  Â  Â  }
Â  Â  Â  Â  #cartTotal {
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  text-align: right;
Â  Â  Â  Â  Â  Â  margin-top: 10px;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Checkout form styles */
Â  Â  Â  Â  #checkoutForm {
Â  Â  Â  Â  Â  Â  margin-top: 20px;
Â  Â  Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  Â  Â  display: none; /* Hidden by default */
Â  Â  Â  Â  }
Â  Â  Â  Â  #checkoutForm input, #checkoutForm textarea {
Â  Â  Â  Â  Â  Â  width: calc(100% - 10px);
Â  Â  Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  }
Â  Â  Â  Â  #checkoutForm .payment-info {
Â  Â  Â  Â  Â  Â  background-color: #333;
Â  Â  Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  margin-top: 15px;
Â  Â  Â  Â  }
Â  Â  Â  Â  #checkoutForm .payment-info a {
Â  Â  Â  Â  Â  Â  color: #e6b800;
Â  Â  Â  Â  Â  Â  text-decoration: underline;
Â  Â  Â  Â  }
Â  Â  Â  Â  #checkoutForm .payment-info a:hover {
Â  Â  Â  Â  Â  Â  color: #ffcc00;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* FIX: Custom style for the 'Size' column to prevent text wrapping.
Â  Â  Â  Â  Â  Â This ensures the content of the 8th column stays on a single line. */
Â  Â  Â  Â  #cigarTable th:nth-child(7),
Â  Â  Â  Â  #cigarTable td:nth-child(7) {
Â  Â  Â  Â  Â  Â  white-space: nowrap;
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  Â  Â  text-overflow: ellipsis;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* New flexbox style for the order button and input field */
Â  Â  Â  Â  .order-controls {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  gap: 5px;
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body oncontextmenu="return false;">
Â  Â  <div class="container">
Â  Â  Â  Â  <h1>Philbo Data Viewer</h1>
Â  Â  Â  Â  <div id="loginBox">
Â  Â  Â  Â  Â  Â  <h2>Login</h2>
Â  Â  Â  Â  Â  Â  <input type="text" id="username" placeholder="Username"><br>
Â  Â  Â  Â  Â  Â  <input type="password" id="password" placeholder="Password"><br>
Â  Â  Â  Â  Â  Â  <button onclick="checkLogin()">Login</button>
Â  Â  Â  Â  Â  Â  <p id="loginError" style="color:red;"></p>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="catalog" style="display:none;">
Â  Â  Â  Â  Â  Â  <input type="text" id="searchBox" placeholder="Search..." onkeyup="filterTable()">
Â  Â  Â  Â  Â  Â  <div id="legend">Legend: V = In stock &nbsp; O = Pre-order by BOX if available</div>
Â  Â  Â  Â  Â  Â  <div id="disclaimer">Prices are indicative and subject to change. The final price is determined by the tax stamp at the time of delivery.</div>
Â  Â  Â  Â  Â  Â  <button class="cart-button" onclick="showCart()">ðŸ›’ Cart (<span id="cartItemCount">0</span>)</button>
Â  Â  Â  Â  Â  Â  <table id="cigarTable">
Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr id="headerRow"></tr>
Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tbody></tbody>
Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div id="cartSummary" style="display:none;">
Â  Â  Â  Â  Â  Â  <h3>Your Order</h3>
Â  Â  Â  Â  Â  Â  <ul id="cartItemsList">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  Â  Â  <p id="cartTotal">Total: â‚¬0.00</p>
Â  Â  Â  Â  Â  Â  <button onclick="showCheckout()">Proceed to Checkout</button>
Â  Â  Â  Â  Â  Â  <button onclick="showCatalog()">Back to Catalog</button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="checkoutForm" style="display:none;">
Â  Â  Â  Â  Â  Â  <h3>Your Details</h3>
Â  Â  Â  Â  Â  Â  <p>Please enter your details and place your order. The order will be sent to us via email.</p>
Â  Â  Â  Â  Â  Â  <input type="text" id="customerName" placeholder="Name" required><br>
Â  Â  Â  Â  Â  Â  <input type="email" id="customerEmail" placeholder="Email" required><br>
Â  Â  Â  Â  Â  Â  <input type="tel" id="customerPhone" placeholder="Phone Number"><br>
Â  Â  Â  Â  Â  Â  <input type="text" id="customerAddress" placeholder="Address"><br>
Â  Â  Â  Â  Â  Â  <textarea id="customerNotes" placeholder="Order notes..." rows="4"></textarea><br>
Â  Â  Â  Â  Â  Â  <div class="payment-info">
Â  Â  Â  Â  Â  Â  Â  Â  <p>Don't forget to pay a 50% deposit via the link below.</p>
Â  Â  Â  Â  Â  Â  Â  Â  <p id="depositAmount">The deposit amount is: â‚¬0.00</p>
Â  Â  Â  Â  Â  Â  Â  Â  <a href="https://revolut.me/alainthgq" target="_blank">revolut.me/alainthgq</a>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <button onclick="sendOrder()">Place Order</button>
Â  Â  Â  Â  Â  Â  <button onclick="showCart()">Back to Cart</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â Â 
Â  Â  Â  Â  <div id="messageModal">
Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  <span class="close-button" onclick="hideMessage()">&times;</span>
Â  Â  Â  Â  <p id="messageText"></p>
Â  Â  Â  </div>
Â  Â  </div>
Â  Â Â 
Â  Â  <script>
Â  Â  Â  Â  // Storage for loaded data and sorting status
Â  Â  Â  Â  let allData = [];
Â  Â  Â  Â  let currentSort = { index: -1, asc: true };
Â  Â  Â  Â  // Cart storage: An array of objects, each with a product and quantity
Â  Â  Â  Â  let cart = [];
Â  Â  Â  Â  let messageTimeoutId = null;

Â  Â  Â  Â  // ===== Helper Functions =====
Â  Â  Â  Â Â 
Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Removes the UTF-8 Byte Order Mark (BOM) if present.
Â  Â  Â  Â  Â * @param {string} s The input string.
Â  Â  Â  Â  Â * @returns {string} The string without the BOM.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function stripBOM(s) { return s && s.charCodeAt(0) === 0xFEFF ? s.slice(1) : s; }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Detects the CSV delimiter.
Â  Â  Â  Â  Â * @param {string} text The CSV text.
Â  Â  Â  Â  Â * @returns {string} The detected delimiter.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function detectDelimiter(text) {
Â  Â  Â  Â  Â  Â  const firstLine = (text.split(/\r?\n/).find(l => l.trim().length > 0) || "");
Â  Â  Â  Â  Â  Â  const counts = { ';': 0, ',': 0, '\t': 0, '|': 0 };
Â  Â  Â  Â  Â  Â  let inQuotes = false;
Â  Â  Â  Â  Â  Â  for (let i = 0; i < firstLine.length; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  const ch = firstLine[i];
Â  Â  Â  Â  Â  Â  Â  Â  if (ch === '"') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (inQuotes && firstLine[i + 1] === '"') { i++; continue; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  inQuotes = !inQuotes; continue;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (!inQuotes && counts.hasOwnProperty(ch)) counts[ch]++;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  let best = ';', bestCount = -1;
Â  Â  Â  Â  Â  Â  for (const k in counts) {
Â  Â  Â  Â  Â  Â  Â  Â  if (counts[k] > bestCount) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  best = k;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bestCount = counts[k];
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return bestCount <= 0 ? ';' : best;
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Parses CSV text into an array of rows.
Â  Â  Â  Â  Â * @param {string} text The CSV text.
Â  Â  Â  Â  Â * @param {string} delimiter The delimiter.
Â  Â  Â  Â  Â * @returns {Array<Array<string>>} The parsed data.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function parseCSV(text, delimiter) {
Â  Â  Â  Â  Â  Â  const rows = [];
Â  Â  Â  Â  Â  Â  let row = [], field = '';
Â  Â  Â  Â  Â  Â  let inQuotes = false;
Â  Â  Â  Â  Â  Â  for (let i = 0; i < text.length; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  const ch = text[i];
Â  Â  Â  Â  Â  Â  Â  Â  if (ch === '"') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (inQuotes && text[i + 1] === '"') { field += '"'; i++; continue; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  inQuotes = !inQuotes; continue;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (!inQuotes && ch === delimiter) { row.push(field); field = ''; continue; }
Â  Â  Â  Â  Â  Â  Â  Â  if (!inQuotes && (ch === '\n' || ch === '\r' && text[i + 1] !== '\n')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  row.push(field); rows.push(row); row = []; field = ''; continue;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (!inQuotes && ch === '\r') { continue; }
Â  Â  Â  Â  Â  Â  Â  Â  field += ch;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (field.length || row.length) { row.push(field); rows.push(row); }
Â  Â  Â  Â  Â  Â  return rows.filter(r => r.some(cell => String(cell).trim().length > 0));
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Normalizes a string for comparison.
Â  Â  Â  Â  Â * @param {string} s The input string.
Â  Â  Â  Â  Â * @returns {string} The normalized string.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function normalizeKey(s) {
Â  Â  Â  Â  Â  Â  return String(s || '')
Â  Â  Â  Â  Â  Â  Â  Â  .toLowerCase()
Â  Â  Â  Â  Â  Â  Â  Â  .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
Â  Â  Â  Â  Â  Â  Â  Â  .replace(/â‚¬/g, 'eur')
Â  Â  Â  Â  Â  Â  Â  Â  .replace(/[^a-z0-9#]+/g, '');
Â  Â  Â  Â  }

Â  Â  Â  Â  // Definitions of the desired columns and their possible names
Â  Â  Â  Â  const TARGETS = [
Â  Â  Â  Â  Â  Â  { label: 'Stock', keys: ['stock', 'voorraad'], loose: ['qty', 'quantity'] },
Â  Â  Â  Â  Â  Â  { label: 'Brand', keys: ['brand'] },
Â  Â  Â  Â  Â  Â  { label: 'Brand 2', keys: ['brand2', 'brand_2', 'subbrand', 'lijn', 'line'] },
Â  Â  Â  Â  Â  Â  { label: 'Brand 3', keys: ['brand3', 'brand_3', 'series', 'serie', 'subline'] },
Â  Â  Â  Â  Â  Â  { label: '# Box', keys: ['#box', 'qtybox', 'aantalperbox', 'aantalbox', 'unitsperbox', 'pcsperbox', 'perbox', 'nbox'] },
Â  Â  Â  Â  Â  Â  { label: 'â‚¬ Box', keys: ['eurbox', 'boxprice', 'prijsbox', 'prijsperbox', 'boxeur', 'eurperbox'] },
Â  Â  Â  Â  Â  Â  { label: 'Size', keys: ['size', 'maat', 'afmeting', 'lengthring', 'format', 'vitola'] },
Â  Â  Â  Â  Â  Â  { label: 'Country', keys: ['country', 'land', 'origin', 'herkomst', 'origine'] }
Â  Â  Â  Â  ];

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Builds a mapping from the CSV headers to the desired columns.
Â  Â  Â  Â  Â * @param {Array<string>} header The array with the raw headers.
Â  Â  Â  Â  Â * @returns {{mapping: Array<number>, norm: Array<string>}} An object with the mapping and normalized headers.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function buildHeaderMapping(header) {
Â  Â  Â  Â  Â  Â  const norm = header.map(normalizeKey);
Â  Â  Â  Â  Â  Â  const used = new Set();
Â  Â  Â  Â  Â  Â  const mapping = new Array(TARGETS.length).fill(-1);

Â  Â  Â  Â  Â  Â  function findIndex(keys, allowLoose) {
Â  Â  Â  Â  Â  Â  Â  Â  for (let i = 0; i < norm.length; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (used.has(i)) continue;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for (const k of keys) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (norm[i] === k) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  used.add(i);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return i;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (!allowLoose) return -1;
Â  Â  Â  Â  Â  Â  Â  Â  for (let i = 0; i < norm.length; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (used.has(i)) continue;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for (const k of keys) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (norm[i].includes(k)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  used.add(i);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return i;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return -1;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  TARGETS.forEach((t, idx) => {
Â  Â  Â  Â  Â  Â  Â  Â  let i = findIndex(t.keys, false);
Â  Â  Â  Â  Â  Â  Â  Â  if (i === -1 && t.loose) i = findIndex(t.loose, true);
Â  Â  Â  Â  Â  Â  Â  Â  mapping[idx] = i;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  return { mapping, norm };
Â  Â  Â  Â  }

Â  Â  Â  Â  // ===== Modal window functions =====
Â  Â  Â  Â Â 
Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Shows a message in the modal window. Disappears after a set time.
Â  Â  Â  Â  Â * @param {string} message The message to display.
Â  Â  Â  Â  Â * @param {number} duration The duration in milliseconds. Use 0 for permanent. Default is 3000ms.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function showMessage(message, duration = 3000) {
            // Clear any existing timeout
            if (messageTimeoutId) {
                clearTimeout(messageTimeoutId);
            }

Â  Â  Â  Â  Â  Â  document.getElementById("messageText").textContent = message;
Â  Â  Â  Â  Â  Â  document.getElementById("messageModal").style.display = "flex";

Â  Â  Â  Â  Â  Â  if (duration > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  messageTimeoutId = setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hideMessage();
Â  Â  Â  Â  Â  Â  Â  Â  }, duration);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Hides the modal window.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function hideMessage() {
            if (messageTimeoutId) {
                clearTimeout(messageTimeoutId);
                messageTimeoutId = null;
            }
Â  Â  Â  Â  Â  Â  document.getElementById("messageModal").style.display = "none";
Â  Â  Â  Â  }

Â  Â  Â  Â  // ===== Login check =====
Â  Â  Â  Â  function checkLogin() {
Â  Â  Â  Â  Â  Â  const user = document.getElementById("username").value.trim();
Â  Â  Â  Â  Â  Â  const pass = document.getElementById("password").value.trim();
Â  Â  Â  Â  Â  Â  if (user === "Philbo" && pass === "sigaren2025") {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("loginBox").style.display = "none";
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("catalog").style.display = "block";
Â  Â  Â  Â  Â  Â  Â  Â  loadCSV();
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("loginError").innerText = "Invalid login!";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // ===== Load CSV and store data =====
Â  Â  Â  Â  function loadCSV() {
Â  Â  Â  Â  Â  Â  fetch("data.csv", { cache: 'no-cache' })
Â  Â  Â  Â  Â  Â  Â  Â  .then(response => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) throw new Error('data.csv not found');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return response.text();
Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  .then(text => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  text = stripBOM(text);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const delim = detectDelimiter(text);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const rows = parseCSV(text, delim);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!rows.length) throw new Error('CSV is empty');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const header = rows[0];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const { mapping } = buildHeaderMapping(header);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const mappedCount = mapping.filter(i => i >= 0).length;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const haveHeader = mappedCount >= 4;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dataRows = haveHeader ? rows.slice(1) : rows;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Store data in memory for quick filtering and sorting
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allData = dataRows.map((row, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newRow = { id: index }; // Add a unique ID to each row
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  TARGETS.forEach((t, idx) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const srcIdx = mapping[idx];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  newRow[t.label] = (srcIdx !== -1 && row[srcIdx] !== undefined) ? row[srcIdx] : '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return newRow;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Render the table for the first time
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderTable(allData);
Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  .catch(err => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessage('Loading error: ' + err.message, 0); // Show this message permanently
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Renders the table with the provided data, including order buttons.
Â  Â  Â  Â  Â * @param {Array<Object>} data The array of data objects.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function renderTable(data) {
Â  Â  Â  Â  Â  Â  const headerRow = document.getElementById("headerRow");
Â  Â  Â  Â  Â  Â  headerRow.innerHTML = '';
Â  Â  Â  Â  Â  Â  TARGETS.forEach((t) => {
Â  Â  Â  Â  Â  Â  Â  Â  const th = document.createElement("th");
Â  Â  Â  Â  Â  Â  Â  Â  th.textContent = t.label;
Â  Â  Â  Â  Â  Â  Â  Â  th.addEventListener("click", () => sortTable(t.label));
Â  Â  Â  Â  Â  Â  Â  Â  headerRow.appendChild(th);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  // Add a header for the order column
Â  Â  Â  Â  Â  Â  const orderHeader = document.createElement("th");
Â  Â  Â  Â  Â  Â  orderHeader.textContent = "Order (boxes)";
Â  Â  Â  Â  Â  Â  headerRow.appendChild(orderHeader);

Â  Â  Â  Â  Â  Â  const tbody = document.querySelector("#cigarTable tbody");
Â  Â  Â  Â  Â  Â  tbody.innerHTML = '';
Â  Â  Â  Â  Â  Â  if (data.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  const tr = document.createElement("tr");
Â  Â  Â  Â  Â  Â  Â  Â  const td = document.createElement("td");
Â  Â  Â  Â  Â  Â  Â  Â  td.colSpan = TARGETS.length + 1; // +1 for the new order column
Â  Â  Â  Â  Â  Â  Â  Â  td.textContent = "No results found.";
Â  Â  Â  Â  Â  Â  Â  Â  td.style.textAlign = "center";
Â  Â  Â  Â  Â  Â  Â  Â  tr.appendChild(td);
Â  Â  Â  Â  Â  Â  Â  Â  tbody.appendChild(tr);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  data.forEach(row => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const tr = document.createElement("tr");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  TARGETS.forEach((t) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const td = document.createElement("td");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  td.textContent = row[t.label] || '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tr.appendChild(td);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Add the order column
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const orderTd = document.createElement("td");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Use a flexbox wrapper div to keep elements on one line
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  orderTd.classList.add('order-controls');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const orderInput = document.createElement("input");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  orderInput.type = "number";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  orderInput.min = "1";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  orderInput.value = "1";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  orderInput.style.width = "50px";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const addButton = document.createElement("button");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addButton.textContent = "Add";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Use the unique ID to find the correct product
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addButton.onclick = () => addToCart(row.id, parseInt(orderInput.value));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  orderTd.appendChild(orderInput);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  orderTd.appendChild(addButton);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tr.appendChild(orderTd);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tbody.appendChild(tr);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // ===== Shopping cart functionality =====
Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Adds a product to the cart.
Â  Â  Â  Â  Â * @param {number} productId The ID of the product.
Â  Â  Â  Â  Â * @param {number} quantity The number of boxes to order.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function addToCart(productId, quantity) {
Â  Â  Â  Â  Â  Â  if (quantity <= 0 || isNaN(quantity)) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessage("Box quantity must be greater than 0.", 3000);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const existingItem = cart.find(item => item.id === productId);
Â  Â  Â  Â  Â  Â  const product = allData.find(item => item.id === productId);

Â  Â  Â  Â  Â  Â  if (existingItem) {
Â  Â  Â  Â  Â  Â  Â  Â  existingItem.quantity += quantity;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  cart.push({ ...product, quantity: quantity });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  updateCartCount();
Â  Â  Â  Â  Â  Â Â 
            // New message with more details and a 2-second duration
            const brand2 = product['Brand 2'] || '';
            const brand3 = product['Brand 3'] || '';
            const size = product.Size || '';
            const message = `Added to cart: ${quantity} x ${brand2} - ${brand3} (${size})`
Â  Â  Â  Â  Â  Â  showMessage(message, 2000); // 2 seconden
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Renders the shopping cart summary.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function renderCart() {
Â  Â  Â  Â  Â  Â  const cartList = document.getElementById("cartItemsList");
Â  Â  Â  Â  Â  Â  const cartTotalEl = document.getElementById("cartTotal");
Â  Â  Â  Â  Â  Â  cartList.innerHTML = '';
Â  Â  Â  Â  Â  Â  let total = 0;

Â  Â  Â  Â  Â  Â  if (cart.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  cartList.innerHTML = '<li>Your cart is empty.</li>';
Â  Â  Â  Â  Â  Â  Â  Â  cartTotalEl.textContent = 'Total: â‚¬0.00';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  cart.forEach(item => {
Â  Â  Â  Â  Â  Â  Â  Â  const li = document.createElement("li");
Â  Â  Â  Â  Â  Â  Â  Â  const priceString = item['â‚¬ Box'] || '0';
Â  Â  Â  Â  Â  Â  Â  Â  const boxPrice = parseFloat(priceString.replace(',', '.'));
Â  Â  Â  Â  Â  Â  Â  Â  const itemTotal = boxPrice * item.quantity;
Â  Â  Â  Â  Â  Â  Â  Â  total += itemTotal;

Â  Â  Â  Â  Â  Â  Â  Â  li.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>${item.quantity} x box of ${item['Brand']} - ${item['Brand 2']} - ${item['Brand 3']} (${item.Size})</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>â‚¬${boxPrice.toFixed(2)}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="quantity-controls">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="updateQuantity(${item.id}, -1)">-</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>${item.quantity}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="updateQuantity(${item.id}, 1)">+</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="removeItem(${item.id})">Remove</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  cartList.appendChild(li);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  cartTotalEl.textContent = `Total: â‚¬${total.toFixed(2)}`;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Updates the quantity of an item in the cart.
Â  Â  Â  Â  Â * @param {number} productId The ID of the product.
Â  Â  Â  Â  Â * @param {number} change The amount to add or remove.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function updateQuantity(productId, change) {
Â  Â  Â  Â  Â  Â  const item = cart.find(i => i.id === productId);
Â  Â  Â  Â  Â  Â  if (item) {
Â  Â  Â  Â  Â  Â  Â  Â  item.quantity += change;
Â  Â  Â  Â  Â  Â  Â  Â  if (item.quantity <= 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  removeItem(productId);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  renderCart();
Â  Â  Â  Â  Â  Â  updateCartCount();
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Removes an item from the cart.
Â  Â  Â  Â  Â * @param {number} productId The ID of the product.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function removeItem(productId) {
Â  Â  Â  Â  Â  Â  cart = cart.filter(item => item.id !== productId);
Â  Â  Â  Â  Â  Â  renderCart();
Â  Â  Â  Â  Â  Â  updateCartCount();
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Updates the item count in the cart button.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function updateCartCount() {
Â  Â  Â  Â  Â  Â  const count = cart.reduce((sum, item) => sum + item.quantity, 0);
Â  Â  Â  Â  Â  Â  document.getElementById("cartItemCount").textContent = count;
Â  Â  Â  Â  }

Â  Â  Â  Â  // ===== Navigation functionality =====
Â  Â  Â  Â  function showCatalog() {
Â  Â  Â  Â  Â  Â  document.getElementById("catalog").style.display = "block";
Â  Â  Â  Â  Â  Â  document.getElementById("cartSummary").style.display = "none";
Â  Â  Â  Â  Â  Â  document.getElementById("checkoutForm").style.display = "none";
Â  Â  Â  Â  }

Â  Â  Â  Â  function showCart() {
Â  Â  Â  Â  Â  Â  document.getElementById("catalog").style.display = "none";
Â  Â  Â  Â  Â  Â  document.getElementById("cartSummary").style.display = "block";
Â  Â  Â  Â  Â  Â  document.getElementById("checkoutForm").style.display = "none";
Â  Â  Â  Â  Â  Â  renderCart();
Â  Â  Â  Â  }

Â  Â  Â  Â  function showCheckout() {
Â  Â  Â  Â  Â  Â  if (cart.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessage("Your cart is empty. Please add products first.", 3000);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Calculate the total
Â  Â  Â  Â  Â  Â  let total = 0;
Â  Â  Â  Â  Â  Â  cart.forEach(item => {
Â  Â  Â  Â  Â  Â  Â  Â  const priceString = item['â‚¬ Box'] || '0';
Â  Â  Â  Â  Â  Â  Â  Â  const boxPrice = parseFloat(priceString.replace(',', '.'));
Â  Â  Â  Â  Â  Â  Â  Â  total += boxPrice * item.quantity;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Calculate the deposit and round it up to the nearest ten
Â  Â  Â  Â  Â  Â  let deposit = total * 0.5;
Â  Â  Â  Â  Â  Â  deposit = Math.ceil(deposit / 10) * 10;

Â  Â  Â  Â  Â  Â  // Update the deposit text in the form
Â  Â  Â  Â  Â  Â  document.getElementById('depositAmount').textContent = `The deposit amount is: â‚¬${deposit.toFixed(2)}`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  document.getElementById("catalog").style.display = "none";
Â  Â  Â  Â  Â  Â  document.getElementById("cartSummary").style.display = "none";
Â  Â  Â  Â  Â  Â  document.getElementById("checkoutForm").style.display = "block";
Â  Â  Â  Â  }

Â  Â  Â  Â  // ===== Send order =====
Â  Â  Â  Â  function sendOrder() {
Â  Â  Â  Â  Â  Â  const name = document.getElementById("customerName").value;
Â  Â  Â  Â  Â  Â  const email = document.getElementById("customerEmail").value;
Â  Â  Â  Â  Â  Â  const phone = document.getElementById("customerPhone").value;
Â  Â  Â  Â  Â  Â  const address = document.getElementById("customerAddress").value;
Â  Â  Â  Â  Â  Â  const notes = document.getElementById("customerNotes").value;

Â  Â  Â  Â  Â  Â  if (!name || !email) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessage("Name and email are required fields.", 3000);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  let orderDetails = "Order from " + name + "\n\n";
Â  Â  Â  Â  Â  Â  orderDetails += "Contact details:\n";
Â  Â  Â  Â  Â  Â  orderDetails += "Name: " + name + "\n";
Â  Â  Â  Â  Â  Â  orderDetails += "Email: " + email + "\n";
Â  Â  Â  Â  Â  Â  if (phone) orderDetails += "Phone: " + phone + "\n";
Â  Â  Â  Â  Â  Â  if (address) orderDetails += "Address: " + address + "\n";
Â  Â  Â  Â  Â  Â  if (notes) orderDetails += "\nNotes:\n" + notes + "\n";
Â  Â  Â  Â  Â  Â  orderDetails += "\nOrdered products:\n";

Â  Â  Â  Â  Â  Â  let total = 0;
Â  Â  Â  Â  Â  Â  cart.forEach(item => {
Â  Â  Â  Â  Â  Â  Â  Â  const priceString = item['â‚¬ Box'] || '0';
Â  Â  Â  Â  Â  Â  Â  Â  const boxPrice = parseFloat(priceString.replace(',', '.'));
Â  Â  Â  Â  Â  Â  Â  Â  const itemTotal = boxPrice * item.quantity;
Â  Â  Â  Â  Â  Â  Â  Â  total += itemTotal;
Â  Â  Â  Â  Â  Â  Â  Â  // Updated to include Brand, Brand 2, Brand 3, and Size
Â  Â  Â  Â  Â  Â  Â  Â  orderDetails += `- ${item.quantity} x box of ${item['Brand']} - ${item['Brand 2']} - ${item['Brand 3']} (${item.Size}) - â‚¬${boxPrice.toFixed(2)} per box\n`;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // Calculate the deposit and remaining amount
Â  Â  Â  Â  Â  Â  let deposit = total * 0.5;
Â  Â  Â  Â  Â  Â  deposit = Math.ceil(deposit / 10) * 10;
Â  Â  Â  Â  Â  Â  const remaining = total - deposit;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Add the amounts to the email body
Â  Â  Â  Â  Â  Â  orderDetails += `\nTotal order amount: â‚¬${total.toFixed(2)}`;
Â  Â  Â  Â  Â  Â  orderDetails += `\nDeposit paid: â‚¬${deposit.toFixed(2)}`;
Â  Â  Â  Â  Â  Â  orderDetails += `\nRemaining amount to pay: â‚¬${remaining.toFixed(2)}`;

Â  Â  Â  Â  Â  Â  const subject = encodeURIComponent("Philbo Data Viewer Order - Order from " + name);
Â  Â  Â  Â  Â  Â  const body = encodeURIComponent(orderDetails);

Â  Â  Â  Â  Â  Â  // Use window.open() to open the mailto link in a new tab
Â  Â  Â  Â  Â  Â  window.open(`mailto:info@philbo.be?subject=${subject}&body=${body}`, '_blank');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Show a message to inform the user and reset the cart
Â  Â  Â  Â  Â  Â  showMessage("Your order has been sent! An email client window should open.", 5000);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Reset the cart after sending
Â  Â  Â  Â  Â  Â  cart = [];
Â  Â  Â  Â  Â  Â  updateCartCount();
Â  Â  Â  Â  Â  Â  showCatalog();
Â  Â  Â  Â  }

Â  Â  Â  Â  // ===== Search function =====
Â  Â  Â  Â  function filterTable() {
Â  Â  Â  Â  Â  Â  const search = document.getElementById("searchBox").value.toLowerCase();
Â  Â  Â  Â  Â  Â  const filteredData = allData.filter(row => {
Â  Â  Â  Â  Â  Â  Â  Â  return Object.values(row).some(cell => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return String(cell).toLowerCase().includes(search);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  renderTable(filteredData);
Â  Â  Â  Â  }

Â  Â  Â  Â  // ===== Sorting =====
Â  Â  Â  Â  function sortTable(key) {
Â  Â  Â  Â  Â  Â  const isAsc = currentSort.key !== key || !currentSort.asc;
Â  Â  Â  Â  Â  Â  currentSort = { key, asc: isAsc };
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Sort the allData array
Â  Â  Â  Â  Â  Â  allData.sort((a, b) => {
Â  Â  Â  Â  Â  Â  Â  Â  const A = String(a[key] || '').trim();
Â  Â  Â  Â  Â  Â  Â  Â  const B = String(b[key] || '').trim();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const numA = parseFloat(A.replace(/[^0-9.,-]/g, "").replace(",", "."));
Â  Â  Â  Â  Â  Â  Â  Â  const numB = parseFloat(B.replace(/[^0-9.,-]/g, "").replace(",", "."));
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let result = 0;
Â  Â  Â  Â  Â  Â  Â  Â  if (!isNaN(numA) && !isNaN(numB)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  result = numA - numB;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  result = A.localeCompare(B, 'en', { sensitivity: 'base' });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  return isAsc ? result : -result;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Render the sorted data
Â  Â  Â  Â  Â  Â  renderTable(allData);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Update the header class for visual indication
Â  Â  Â  Â  Â  Â  const headers = document.querySelectorAll("#headerRow th");
Â  Â  Â  Â  Â  Â  headers.forEach(h => {
Â  Â  Â  Â  Â  Â  Â  Â  h.classList.remove("sort-asc", "sort-desc");
Â  Â  Â  Â  Â  Â  Â  Â  if (h.textContent === key) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  h.classList.add(isAsc ? "sort-asc" : "sort-desc");
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  // ===== Restrict copying/printing =====
Â  Â  Â  Â  document.addEventListener("keydown", function(e) {
Â  Â  Â  Â  Â  Â  const k = e.key.toLowerCase();
Â  Â  Â  Â  Â  Â  if (e.key === "PrintScreen" || (e.ctrlKey && (k === "c" || k === "p" || k === "s")) || (e.metaKey && (k === "c" || k === "p" || k === "s"))) {
Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  Â  Â  showMessage("Copying/printing/saving is blocked!", 0); // Permanent
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  </script>
</body>
</html>
